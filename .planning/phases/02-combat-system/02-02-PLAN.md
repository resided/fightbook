---
phase: 02-combat-system
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified: []
autonomous: true
requirements: [CPU-07, PRIZ-01]
must_haves:
  truths:
    - "Fight results saved to Supabase database"
    - "Battle log viewable in history"
    - "Winner receives $FIGHT (manual awarding)"
  artifacts:
    - path: "supabase/schema.sql"
      provides: "Fights table schema"
      adds: "create table fights"
    - path: "src/lib/fightStorage.ts"
      provides: "Fight persistence to Supabase"
      exports: ["saveFightToDb", "getFightHistory", "getFightsByAgent"]
    - src: "src/components/FightHistory.tsx"
      provides: "View past fights"
      min_lines: 50
    - src: "src/components/PrizeAward.tsx"
      provides: "Manual prize awarding"
      min_lines: 30
  key_links:
    - from: "src/components/TextFight.tsx"
      to: "src/lib/fightStorage.ts"
      via: "saveFightToDb()"
      pattern: "saveFightToDb"
    - from: "src/components/FightHistory.tsx"
      to: "src/lib/fightStorage.ts"
      via: "getFightHistory()"
      pattern: "getFightHistory"
user_setup: []
---

<objective>
Persist battle logs to Supabase and create manual prize awarding system.

Purpose: Fight results persist beyond browser session. Manual prize system for awarding $FIGHT to winners.
Output: Database schema for fights, fight storage API, history view, prize UI.
</objective>

<context>
@/Users/fightbook/fightbook/src/lib/storage.ts
@/Users/fightbook/fightbook/src/lib/fighterStorage.ts
@/Users/fightbook/fightbook/src/components/TextFight.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fights table to database schema</name>
  <files>supabase/schema.sql</files>
  <action>
    Update supabase/schema.sql:
    1. Add fights table:
       - id (UUID, primary key)
       - user_id (UUID, references auth.users)
       - agent1_id (UUID, references fighters.id)
       - agent2_id (UUID, references fighters.id)
       - winner_id (UUID, nullable - references fighters.id)
       - method (text: 'KO'/'TKO'/'SUB'/'DEC'/'DRAW')
       - round (integer)
       - end_time (integer, seconds into round)
       - fight_data (JSONB, full FightState)
       - prize_awarded (boolean, default false)
       - prize_amount (integer, default 0)
       - created_at (timestamptz)
    2. Add RLS policy: "Users can view own fights"
    3. Also add to fighterStorage.ts: updateFighterStats() to update wins/losses in database after fight
  </action>
  <verify>schema.sql contains fights table with all columns</verify>
  <done>Database can store fight records with winner and prize info</done>
</task>

<task type="auto">
  <name>Task 2: Create fight storage API</name>
  <files>src/lib/fightStorage.ts</files>
  <action>
    Create src/lib/fightStorage.ts:
    1. saveFightToDb(fightRecord): Saves complete fight to Supabase fights table
    2. getFightHistory(): Returns all fights for current user (newest first)
    3. getFightsByAgent(agentId): Returns fights involving specific agent
    4. getFightById(id): Returns single fight by ID
    5. awardPrize(fightId, amount): Updates prize_awarded and prize_amount for fight

    Integrate with existing FightRecord type from storage.ts.
    Use supabase client from lib/supabase.ts.
  </action>
  <verify>fightStorage.ts exists with all 5 functions exported</verify>
  <done>Fight storage API ready to save/retrieve fights from Supabase</done>
</task>

<task type="auto">
  <name>Task 3: Update TextFight to save to database</name>
  <files>src/components/TextFight.tsx</files>
  <action>
    Update src/components/TextFight.tsx:
    1. Import saveFightToDb from fightStorage
    2. In onFightComplete callback:
       - Save fight to Supabase via saveFightToDb()
       - Also keep localStorage save for offline capability
       - Update fighter stats in database via fighterStorage.updateFighter()
    3. Show toast: "Fight saved!" or "Fight saved. Prize pending..." based on save success

    The fight now persists to Supabase, updating fighter records.
  </action>
  <verify>TextFight saves to Supabase on fight completion</verify>
  <done>Fights persist to database after completion</done>
</task>

<task type="auto">
  <name>Task 4: Create fight history view</name>
  <files>src/components/FightHistory.tsx</files>
  <action>
    Create src/components/FightHistory.tsx:
    1. Load fights from fightStorage.getFightHistory() on mount
    2. Display list of past fights:
       - Date/time
       - Fighter 1 vs Fighter 2
       - Winner (highlighted)
       - Method (KO/TKO/SUB/DEC/DRAW)
       - Round
       - Prize awarded badge (if applicable)
    3. Click fight to expand full fight log (actions, damage, etc.)
    4. Filter: All / Wins / Losses
    5. Empty state: "No fights yet. Start your first fight!"
    6. Use ScrollArea and Card components
  </action>
  <verify>Component displays fight history from database</verify>
  <done>User can view past fights with details</done>
</task>

<task type="auto">
  <name>Task 5: Create manual prize awarding UI</name>
  <files>src/components/PrizeAward.tsx</files>
  <action>
    Create src/components/PrizeAward.tsx:
    1. Props: fightId
    2. Display: "Award Prize to Winner"
    3. Input: Amount ($FIGHT tokens - integer input, default 100)
    4. "Award Prize" button that:
       - Calls fightStorage.awardPrize(fightId, amount)
       - Shows success toast with amount
    5. If prize already awarded: show "Already awarded: $X" with disabled input

    This is a simple manual system - admin/user manually awards prizes after verifying win.
  </action>
  <verify>Component allows entering prize amount and saving to database</verify>
  <done>Winners can receive manual prize awards</done>
</task>

</tasks>

<verification>
[ ] fights table exists in schema.sql
[ ] fightStorage.ts has saveFightToDb and awardPrize
[ ] TextFight saves fights to Supabase on completion
[ ] FightHistory.tsx displays past fights
[ ] PrizeAward.tsx allows manual prize awarding
[ ] Prize shows in fight history after awarded
</verification>

<success_criteria>
Fights persist to Supabase database. User can view fight history. Manual prize awarding updates database and displays in history.
</success_criteria>

<output>
After completion, create `.planning/phases/02-combat-system/02-02-SUMMARY.md`
</output>
